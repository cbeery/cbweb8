<!-- app/views/admin/rides/calculator.html.erb -->
<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-8">Mileage Calculator</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Calculator Form -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Calculate Mileage</h2>
      
      <%= form_with url: calculator_admin_rides_path, method: :get, local: true, class: "space-y-4" do |f| %>
        <!-- Calculation Type -->
        <div>
          <%= f.label :calculation_type, "Calculation Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :calculation_type, 
              options_for_select([
                ['All-Time Total', 'all_time'],
                ['Date Range', 'date_range'],
                ['Since Milestone', 'since_milestone'],
                ['Between Milestones', 'between_milestones']
              ], params[:calculation_type]),
              {}, 
              { class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",
                'data-calculator-type': true } %>
        </div>
        
        <!-- Bicycle Selection (for all calculations) -->
        <div>
          <%= f.label :bicycle_id, "Bicycle", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :bicycle_id, 
              options_for_select(
                [['All Bicycles', '']] + @bicycles.map { |b| [b.name, b.id] },
                params[:bicycle_id]
              ),
              {}, 
              { class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",
                'data-bicycle-select': true } %>
        </div>
        
        <!-- Date Range Fields -->
        <div id="date-range-fields" class="space-y-4" style="<%= params[:calculation_type] == 'date_range' ? '' : 'display: none;' %>">
          <div>
            <%= f.label :start_date, "Start Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.date_field :start_date, value: params[:start_date], 
                class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
          <div>
            <%= f.label :end_date, "End Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.date_field :end_date, value: params[:end_date] || Date.current, 
                class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
        </div>
        
        <!-- Milestone Selection -->
        <div id="milestone-fields" style="<%= params[:calculation_type] == 'since_milestone' ? '' : 'display: none;' %>">
          <%= f.label :milestone_id, "Milestone", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <select name="milestone_id" id="milestone-select" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Select a milestone...</option>
            <% @bicycles.each do |bicycle| %>
              <% if bicycle.milestones.any? %>
                <optgroup label="<%= bicycle.name %>">
                  <% bicycle.milestones.recent.each do |milestone| %>
                    <option value="<%= milestone.id %>" <%= 'selected' if params[:milestone_id] == milestone.id.to_s %>>
                      <%= milestone.title %> (<%= milestone.occurred_on.strftime("%b %d, %Y") %>)
                    </option>
                  <% end %>
                </optgroup>
              <% end %>
            <% end %>
          </select>
        </div>
        
        <!-- Between Milestones Fields -->
        <div id="between-milestones-fields" class="space-y-4" style="<%= params[:calculation_type] == 'between_milestones' ? '' : 'display: none;' %>">
          <div>
            <%= f.label :start_milestone_id, "Start Milestone", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <select name="start_milestone_id" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select start milestone...</option>
              <% @bicycles.each do |bicycle| %>
                <% if bicycle.milestones.any? %>
                  <optgroup label="<%= bicycle.name %>">
                    <% bicycle.milestones.recent.each do |milestone| %>
                      <option value="<%= milestone.id %>" <%= 'selected' if params[:start_milestone_id] == milestone.id.to_s %>>
                        <%= milestone.title %> (<%= milestone.occurred_on.strftime("%b %d, %Y") %>)
                      </option>
                    <% end %>
                  </optgroup>
                <% end %>
              <% end %>
            </select>
          </div>
          <div>
            <%= f.label :end_milestone_id, "End Milestone", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <select name="end_milestone_id" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select end milestone...</option>
              <% @bicycles.each do |bicycle| %>
                <% if bicycle.milestones.any? %>
                  <optgroup label="<%= bicycle.name %>">
                    <% bicycle.milestones.recent.each do |milestone| %>
                      <option value="<%= milestone.id %>" <%= 'selected' if params[:end_milestone_id] == milestone.id.to_s %>>
                        <%= milestone.title %> (<%= milestone.occurred_on.strftime("%b %d, %Y") %>)
                      </option>
                    <% end %>
                  </optgroup>
                <% end %>
              <% end %>
            </select>
          </div>
        </div>
        
        <%= hidden_field_tag :calculate, true %>
        <%= f.submit "Calculate", class: "w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition" %>
      <% end %>
    </div>
    
    <!-- Results -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Results</h2>
      
      <% if @error %>
        <div class="bg-red-50 border border-red-200 rounded p-4">
          <p class="text-red-600"><%= @error %></p>
        </div>
      <% elsif @result %>
        <div class="space-y-4">
          <!-- Context Info -->
          <% if @calculation_type == 'all_time' %>
            <div class="bg-blue-50 border border-blue-200 rounded p-4">
              <p class="text-sm text-blue-600 font-medium">All-Time Total</p>
              <p class="text-lg font-semibold"><%= @result[:bicycle] %></p>
            </div>
          <% elsif @calculation_type == 'date_range' %>
            <div class="bg-blue-50 border border-blue-200 rounded p-4">
              <p class="text-sm text-blue-600 font-medium">Date Range</p>
              <p class="text-lg font-semibold"><%= @result[:period] %></p>
            </div>
          <% elsif @calculation_type == 'since_milestone' %>
            <div class="bg-blue-50 border border-blue-200 rounded p-4">
              <p class="text-sm text-blue-600 font-medium">Since Milestone</p>
              <p class="text-lg font-semibold"><%= @result[:milestone] %></p>
              <p class="text-sm text-gray-600">
                <%= @result[:occurred_on].strftime("%B %d, %Y") %> 
                (<%= pluralize(@result[:days_since], 'day') %> ago)
              </p>
            </div>
          <% elsif @calculation_type == 'between_milestones' %>
            <div class="bg-blue-50 border border-blue-200 rounded p-4">
              <p class="text-sm text-blue-600 font-medium">Between Milestones</p>
              <p class="text-lg font-semibold"><%= @result[:start_milestone] %></p>
              <p class="text-sm text-gray-600">to</p>
              <p class="text-lg font-semibold"><%= @result[:end_milestone] %></p>
            </div>
          <% end %>
          
          <!-- Stats Grid -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-gray-50 rounded p-4">
              <p class="text-sm text-gray-600">Total Miles</p>
              <p class="text-2xl font-bold text-gray-900">
                <%= number_with_delimiter(@result[:miles].round(2)) %>
              </p>
            </div>
            
            <div class="bg-gray-50 rounded p-4">
              <p class="text-sm text-gray-600">Total Rides</p>
              <p class="text-2xl font-bold text-gray-900">
                <%= number_with_delimiter(@result[:rides]) %>
              </p>
            </div>
            
            <div class="bg-gray-50 rounded p-4">
              <p class="text-sm text-gray-600">Total Time</p>
              <p class="text-2xl font-bold text-gray-900">
                <%= @result[:duration] %>
              </p>
            </div>
            
            <div class="bg-gray-50 rounded p-4">
              <p class="text-sm text-gray-600">Avg per Ride</p>
              <p class="text-2xl font-bold text-gray-900">
                <%= @result[:rides] > 0 ? (@result[:miles] / @result[:rides]).round(1) : 0 %> mi
              </p>
            </div>
          </div>
        </div>
      <% else %>
        <p class="text-gray-500">Select calculation parameters and click Calculate to see results.</p>
      <% end %>
    </div>
  </div>

  <!-- Common Calculations -->
  <div class="mt-8 bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold mb-4">Quick Calculations</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <% @bicycles.active.each do |bicycle| %>
        <div class="border rounded p-4">
          <h3 class="font-medium text-gray-900 mb-2"><%= bicycle.name %></h3>
          <p class="text-sm text-gray-600">
            All-time: <span class="font-semibold"><%= number_with_delimiter(bicycle.total_miles.round) %> miles</span>
          </p>
          <p class="text-sm text-gray-600">
            This year: <span class="font-semibold"><%= bicycle.miles_between(Date.current.beginning_of_year, Date.current).round %> miles</span>
          </p>
          <% if bicycle.milestones.any? && bicycle.milestones.select(&:maintenance?).any? %>
            <% last_maintenance = bicycle.milestones.select(&:maintenance?).first %>
            <p class="text-sm text-gray-600">
              Since <%= last_maintenance.title %>: 
              <span class="font-semibold"><%= last_maintenance.miles_since.round %> miles</span>
            </p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const typeSelect = document.querySelector('[data-calculator-type]');
  const dateRangeFields = document.getElementById('date-range-fields');
  const milestoneFields = document.getElementById('milestone-fields');
  const betweenMilestonesFields = document.getElementById('between-milestones-fields');
  
  if (typeSelect) {
    typeSelect.addEventListener('change', function() {
      // Hide all conditional fields
      dateRangeFields.style.display = 'none';
      milestoneFields.style.display = 'none';
      betweenMilestonesFields.style.display = 'none';
      
      // Show relevant fields
      switch(this.value) {
        case 'date_range':
          dateRangeFields.style.display = 'block';
          break;
        case 'since_milestone':
          milestoneFields.style.display = 'block';
          break;
        case 'between_milestones':
          betweenMilestonesFields.style.display = 'block';
          break;
      }
    });
  }
});
</script>
