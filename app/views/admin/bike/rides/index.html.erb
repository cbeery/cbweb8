<!-- app/views/admin/bike/rides/index.html.erb -->
<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Rides</h1>
      <p class="text-gray-600 mt-2">
        <%= @stats[:total_rides] %> rides • 
        <%= number_with_delimiter(@stats[:total_miles]&.round || 0) %> miles • 
        <%= (@stats[:total_duration] / 3600.0).round rescue 0 %> hours
      </p>
    </div>
    <%= link_to "Mileage Calculator", calculator_admin_bike_rides_path, 
                class: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition" %>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg shadow mb-6 p-4">
    <%= form_with url: admin_bike_rides_path, method: :get, local: true, class: "space-y-4" do |f| %>
      <!-- Row 1: Date Range -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <%= f.label :start_date, "Start Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.date_field :start_date, value: params[:start_date], 
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= f.label :end_date, "End Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.date_field :end_date, value: params[:end_date], 
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= f.label :sort, "Sort By", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :sort, 
              options_for_select([
                ['Most Recent', 'date_desc'],
                ['Oldest First', 'date_asc'],
                ['Longest Distance', 'miles_desc'],
                ['Shortest Distance', 'miles_asc'],
                ['Longest Duration', 'duration'],
                ['Fastest Speed', 'speed']
              ], params[:sort]),
              {}, 
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
      </div>
      
      <!-- Row 2: Other Filters -->
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <%= f.select :bicycle_id, 
              options_for_select([['All Bicycles', '']] + @available_bicycles, params[:bicycle_id]),
              {}, 
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= f.select :year, 
              options_for_select([['All Years', '']] + @available_years.map { |y| [y, y] }, params[:year]),
              {}, 
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= f.select :month, 
              options_for_select([
                ['All Months', ''],
                ['January', 1], ['February', 2], ['March', 3],
                ['April', 4], ['May', 5], ['June', 6],
                ['July', 7], ['August', 8], ['September', 9],
                ['October', 10], ['November', 11], ['December', 12]
              ], params[:month]),
              {}, 
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= f.select :strava, 
              options_for_select([
                ['All Rides', ''],
                ['With Strava', 'true'],
                ['Without Strava', 'false']
              ], params[:strava]),
              {}, 
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= f.number_field :min_miles, value: params[:min_miles], 
              placeholder: "Min miles",
              step: 0.1,
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= f.number_field :max_miles, value: params[:max_miles], 
              placeholder: "Max miles",
              step: 0.1,
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
      </div>
      
      <!-- Row 3: Search and Actions -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.text_field :q, value: params[:q], 
              placeholder: "Search notes...",
              class: "w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div class="flex gap-2">
          <%= f.submit "Apply Filters", class: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" %>
          <%= link_to "Clear", admin_bike_rides_path, class: "bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300" %>
          <%= link_to "Export CSV", admin_bike_rides_path(format: :csv, **params.permit!), 
              class: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" if false %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Stats Summary -->
  <% if @stats[:total_rides] > 0 %>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-600">Average Distance</p>
        <p class="text-xl font-bold text-gray-900"><%= @stats[:average_miles] || 0 %> mi</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-600">Longest Ride</p>
        <p class="text-xl font-bold text-gray-900"><%= @stats[:longest_ride] || 0 %> mi</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-600">Average Speed</p>
        <p class="text-xl font-bold text-gray-900"><%= @stats[:average_speed] || 0 %> mph</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-600">Total Time</p>
        <p class="text-xl font-bold text-gray-900"><%= (@stats[:total_duration] / 3600.0).round rescue 0 %> hrs</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-600">With Strava</p>
        <p class="text-xl font-bold text-gray-900">
          <%= ((Ride.with_strava.count.to_f / Ride.count) * 100).round rescue 0 %>%
        </p>
      </div>
    </div>
  <% end %>

  <!-- Rides Table -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Date
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Bicycle
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Distance
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Duration
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Speed
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Notes
          </th>
          <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Strava
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @rides.each do |ride| %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <%= link_to ride.rode_on.strftime("%b %d, %Y"), admin_bike_rides_path(ride), 
                  class: "text-blue-600 hover:text-blue-900 font-medium" %>
              <p class="text-xs text-gray-500"><%= ride.rode_on.strftime("%A") %></p>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <%= link_to ride.bicycle.name, admin_bike_bicycles_path(ride.bicycle), 
                  class: "text-gray-900 hover:text-blue-600" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= ride.miles %> mi
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= ride.duration_formatted if ride.duration.present? %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <% if ride.average_speed > 0 %>
                <%= ride.average_speed %> mph
              <% else %>
                <span class="text-gray-400">-</span>
              <% end %>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
              <% if ride.notes.present? %>
                <%= truncate(ride.notes, length: 40) %>
              <% else %>
                <span class="text-gray-400">-</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <% if ride.from_strava? %>
                <span class="text-green-600" title="Synced from Strava">✓</span>
              <% else %>
                <span class="text-gray-400">-</span>
              <% end %>
            </td>
          </tr>
        <% end %>
        
        <% if @rides.empty? %>
          <tr>
            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
              No rides found matching your filters.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-6 flex justify-center">
    <%= paginate @rides %>
  </div>
</div>
