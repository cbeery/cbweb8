<%# app/views/admin/lastfm/_top_table.html.erb %>
<%= turbo_frame_tag "#{@category}-#{@period}-frame" do %>
  <div class="overflow-x-auto shadow ring-1 ring-black ring-opacity-5 rounded-lg">
    <table class="min-w-full divide-y divide-gray-300 table-fixed">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="py-2 px-2 text-left text-sm font-semibold text-gray-900 w-10">
            #
          </th>
          <th scope="col" class="px-3 py-2 text-left text-sm font-semibold text-gray-900">
            Artist
          </th>
          <% if @category != 'artist' %>
            <th scope="col" class="px-3 py-2 text-left text-sm font-semibold text-gray-900">
              <%= @category.capitalize %>
            </th>
          <% end %>
          <th scope="col" class="px-3 py-2 text-left text-sm font-semibold text-gray-900 w-16">
            Plays
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 bg-white">
        <% if @top_scrobbles.any? %>
          <% @top_scrobbles.each do |scrobble| %>
            <%# Look up the image from preloaded @images hash %>
            <% image_key = @category == 'artist' ? [scrobble.artist, nil] : [scrobble.artist, scrobble.name] %>
            <% image_record = @images[image_key] %>
            <% has_image = image_record&.has_image? %>
            <% image_url = image_record&.image_url %>
            <tr class="hover:bg-gray-50 group">
              <td class="py-2 px-2 text-sm text-gray-500 whitespace-nowrap">
                <%= scrobble.position %>
              </td>
              <td class="whitespace-nowrap px-3 py-2 text-sm text-gray-500">
                <div class="flex items-center gap-3">
                  <%# Image thumbnail with hover effect %>
                  <div class="relative flex-shrink-0">
                    <% if has_image %>
                      <img src="<%= image_url %>"
                           alt="<%= scrobble.artist %>"
                           loading="lazy"
                           class="w-8 h-8 object-cover <%= @category == 'artist' ? 'rounded-full' : 'rounded' %> bg-gray-200 transition-transform group-hover:scale-110"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                      <%# Fallback (hidden by default, shown on error) %>
                      <div class="w-8 h-8 <%= @category == 'artist' ? 'rounded-full' : 'rounded' %> bg-gray-200 items-center justify-center hidden">
                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        </svg>
                      </div>
                    <% else %>
                      <%# No image available - show placeholder %>
                      <div class="w-8 h-8 <%= @category == 'artist' ? 'rounded-full' : 'rounded' %> bg-gray-200 flex items-center justify-center">
                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        </svg>
                      </div>
                    <% end %>
                  </div>
                  <%# Artist name %>
                  <% if scrobble.url.present? %>
                    <%= link_to scrobble.artist, scrobble.url,
                                target: "_blank",
                                rel: "noopener",
                                class: "text-indigo-600 hover:text-indigo-900" %>
                  <% else %>
                    <%= scrobble.artist %>
                  <% end %>
                </div>
              </td>
              <% if @category != 'artist' %>
                <td class="px-3 py-2 text-sm text-gray-500">
                  <%= scrobble.name %>
                </td>
              <% end %>
              <td class="whitespace-nowrap px-3 py-2 text-sm text-gray-500">
                <%= number_with_delimiter(scrobble.plays) %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="<%= @category == 'artist' ? 3 : 4 %>" class="px-6 py-12 text-center text-sm text-gray-500">
              No data available for this period.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
