<!-- app/views/admin/movies/enrich_step2.html.erb -->
<% content_for :title, "Enrich Movie: #{@movie.title}" %>

<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Progress Steps -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-gray-900">TMDB Data</h3>
            <p class="text-xs text-gray-500">✓ Director: <%= @movie.director || 'Not set' %></p>
          </div>
        </div>
        
        <div class="flex-1 mx-4">
          <div class="h-0.5 bg-green-600"></div>
        </div>
        
        <div class="flex items-center">
          <div class="flex items-center justify-center w-10 h-10 bg-indigo-600 text-white rounded-full">2</div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-gray-900">Viewing Details</h3>
            <p class="text-xs text-gray-500">Location & series</p>
          </div>
        </div>
        
        <div class="flex-1 mx-4">
          <div class="h-0.5 bg-gray-300"></div>
        </div>
        
        <div class="flex items-center">
          <div class="flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-600 rounded-full">3</div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-gray-400">Poster</h3>
            <p class="text-xs text-gray-400">Select artwork</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-lg shadow-lg">
      <div class="px-6 py-4 border-b">
        <h1 class="text-2xl font-bold text-gray-900">Viewing Details</h1>
        <p class="mt-1 text-sm text-gray-600">
          Where did you watch "<%= @movie.title %>"?
          <% if @viewing.viewed_on.present? %>
            <span class="text-gray-500">(on <%= @viewing.viewed_on.strftime('%B %d, %Y') %>)</span>
          <% end %>
        </p>
      </div>

      <div class="px-6 py-6">
        <%= form_with url: process_enrichment_admin_movie_path(@movie), 
            method: :patch,
            local: true,
            data: { turbo: false } do |f| %>
          
          <!-- Hidden field to indicate we want to continue to posters -->
          <%= f.hidden_field :continue_to_posters, value: true %>
          
          <%= f.fields_for :viewing, @viewing do |vf| %>
            <%= vf.hidden_field :id if @viewing.persisted? %>
            
            <!-- Hidden field for viewed_on -->
            <%= vf.hidden_field :viewed_on, value: @viewing.viewed_on || Date.current %>
            
            <div class="space-y-6">
              <!-- Location Selection -->
              <div>
                <%= vf.label :location, "Where did you watch?", 
                    class: "block text-sm font-medium text-gray-700 mb-2" %>
                <div class="flex space-x-4">
                  <label class="flex-1">
                    <%= vf.radio_button :location, 'home', 
                        checked: @viewing.location == 'home' || @viewing.location.blank?,
                        class: "peer sr-only",
                        onchange: "toggleTheaterSection()" %>
                    <div class="px-4 py-3 border-2 rounded-lg cursor-pointer transition
                                peer-checked:border-indigo-600 peer-checked:bg-indigo-50
                                hover:bg-gray-50">
                      <div class="flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                        </svg>
                        <span class="font-medium">Home</span>
                      </div>
                    </div>
                  </label>
                  
                  <label class="flex-1">
                    <%= vf.radio_button :location, 'theater', 
                        checked: @viewing.location == 'theater',
                        class: "peer sr-only",
                        onchange: "toggleTheaterSection()" %>
                    <div class="px-4 py-3 border-2 rounded-lg cursor-pointer transition
                                peer-checked:border-indigo-600 peer-checked:bg-indigo-50
                                hover:bg-gray-50">
                      <div class="flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-medium">Theater</span>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
              
              <!-- Theater Selection (shown when theater is selected) -->
              <div id="theater-details" style="<%= @viewing.location == 'theater' ? '' : 'display: none;' %>">
                <div class="space-y-4">
                  <!-- Theater Dropdown -->
                  <div>
                    <%= vf.label :theater_id, "Theater", 
                        class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <div class="flex space-x-2">
                      <%= vf.select :theater_id,
                          options_for_select(Theater.for_select, @viewing.theater_id),
                          { include_blank: "Select theater..." },
                          class: "flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                          id: "theater_select" %>
                      <button type="button" 
                              onclick="showNewTheaterModal()"
                              class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Price -->
                  <div>
                    <%= vf.label :price, "Ticket Price (optional)", 
                        class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <%= vf.number_field :price, 
                        value: @viewing.price,
                        step: 0.01,
                        placeholder: "0.00",
                        class: "w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
                  </div>
                  
                  <!-- Format -->
                  <div>
                    <%= vf.label :format, "Format (optional)", 
                        class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <%= vf.select :format,
                        options_for_select([
                          ['Standard', 'standard'],
                          ['IMAX', 'imax'],
                          ['Dolby', 'dolby'],
                          ['3D', '3d'],
                          ['70mm', '70mm'],
                          ['35mm', '35mm'],
                          ['Digital', 'digital']
                        ], @viewing.format),
                        { include_blank: "Select format..." },
                        class: "w-48 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
                  </div>
                </div>
              </div>
              
              <!-- Film Series Section -->
              <div class="border-t pt-6">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Film Series (optional)</h3>
                
                <div class="space-y-4">
                  <!-- Film Series Dropdown -->
                  <div>
                    <div class="flex space-x-2">
                      <select id="film_series_select"
                              onchange="loadFilmSeriesEvents(this.value)"
                              class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">No film series...</option>
                        <% @film_series.each do |series| %>
                          <option value="<%= series.id %>"
                                  <%= 'selected' if @viewing.film_series_event&.film_series_id == series.id %>>
                            <%= series.name %>
                          </option>
                        <% end %>
                      </select>
                      <button type="button" 
                              onclick="showNewSeriesModal()"
                              class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Film Series Event Dropdown (shown when series selected) -->
                  <div id="series-event-section" style="<%= @viewing.film_series_event.present? ? '' : 'display: none;' %>">
                    <%= vf.label :film_series_event_id, "Event", 
                        class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <div class="flex space-x-2">
                      <%= vf.select :film_series_event_id,
                          options_for_select(
                            @film_series_events.map { |e| [e.display_name, e.id] },
                            @viewing.film_series_event_id
                          ),
                          { include_blank: "Select event..." },
                          class: "flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                          id: "film_series_event_select" %>
                      <button type="button" 
                              onclick="showNewEventModal()"
                              class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Notes -->
              <div>
                <%= vf.label :notes, "Notes (optional)", 
                    class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= vf.text_area :notes,
                    value: @viewing.notes,
                    rows: 3,
                    placeholder: "Any thoughts about this viewing...",
                    class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
              </div>
            </div>
          <% end %>
          
          <!-- Navigation -->
          <div class="mt-8 pt-6 border-t flex justify-between">
            <%= link_to "← Back", 
                enrich_admin_movie_path(@movie),
                class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 font-medium" %>
            <div class="space-x-2">
              <%= f.submit "Save & Return", 
                  name: "save_and_return",
                  formaction: process_enrichment_admin_movie_path(@movie, continue_to_posters: false),
                  class: "px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 cursor-pointer font-medium" %>
              <%= f.submit "Continue to Posters →", 
                  class: "px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 cursor-pointer font-medium" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleTheaterSection() {
    const theaterRadio = document.querySelector('input[name="viewing[location]"][value="theater"]:checked');
    const theaterDetails = document.getElementById('theater-details');
    
    if (theaterRadio) {
      theaterDetails.style.display = 'block';
    } else {
      theaterDetails.style.display = 'none';
    }
  }
  
  function loadFilmSeriesEvents(seriesId) {
    const eventSection = document.getElementById('series-event-section');
    const eventSelect = document.getElementById('film_series_event_select');
    
    if (!seriesId) {
      eventSection.style.display = 'none';
      eventSelect.innerHTML = '<option value="">Select event...</option>';
      return;
    }
    
    // Show the section
    eventSection.style.display = 'block';
    
    // Fetch events for this series
    fetch(`/admin/film_series_events/for_series?series_id=${seriesId}`)
      .then(response => response.json())
      .then(data => {
        eventSelect.innerHTML = '<option value="">Select event...</option>';
        data.events.forEach(event => {
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = event.name;
          eventSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error loading events:', error);
      });
  }
  
  // Modal functions (simplified versions - you can enhance these)
  function showNewTheaterModal() {
    const name = prompt('Theater name:');
    if (!name) return;
    
    const city = prompt('City (optional):');
    const state = prompt('State (optional):');
    
    // Create theater via AJAX
    fetch('/admin/theaters/quick_create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ theater: { name, city, state } })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id) {
        // Add to select and select it
        const select = document.getElementById('theater_select');
        const option = new Option(data.display_name || data.name, data.id, true, true);
        select.add(option);
      } else {
        alert('Error: ' + (data.errors || ['Unknown error']).join(', '));
      }
    });
  }
  
  function showNewSeriesModal() {
    const name = prompt('Film Series name:');
    if (!name) return;
    
    fetch('/admin/film_series/quick_create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ film_series: { name } })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id) {
        const select = document.getElementById('film_series_select');
        const option = new Option(data.name, data.id, true, true);
        select.add(option);
        // Trigger event loading
        loadFilmSeriesEvents(data.id);
      }
    });
  }
  
  function showNewEventModal() {
    const seriesId = document.getElementById('film_series_select').value;
    if (!seriesId) {
      alert('Please select a film series first');
      return;
    }
    
    const name = prompt('Event name:');
    if (!name) return;
    
    const startDate = prompt('Start date (YYYY-MM-DD):');
    if (!startDate) return;
    
    fetch('/admin/film_series_events/quick_create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ 
        film_series_event: { 
          name, 
          film_series_id: seriesId,
          started_on: startDate 
        } 
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id) {
        const select = document.getElementById('film_series_event_select');
        const option = new Option(data.name, data.id, true, true);
        select.add(option);
      }
    });
  }
</script>
