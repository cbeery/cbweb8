<!-- app/views/admin/movies/enrich_step2.html.erb -->
<% content_for :title, "Enrich Movie: #{@movie.title}" %>

<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Progress Steps -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-gray-900">TMDB Data</h3>
            <p class="text-xs text-gray-500">✓ Director: <%= @movie.director || 'Not set' %></p>
          </div>
        </div>
        
        <div class="flex-1 mx-4">
          <div class="h-0.5 bg-green-600"></div>
        </div>
        
        <div class="flex items-center">
          <div class="flex items-center justify-center w-10 h-10 bg-indigo-600 text-white rounded-full">2</div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-gray-900">Viewing Details</h3>
            <p class="text-xs text-gray-500">Location & details</p>
          </div>
        </div>
        
        <div class="flex-1 mx-4">
          <div class="h-0.5 bg-gray-300"></div>
        </div>
        
        <div class="flex items-center">
          <div class="flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-600 rounded-full">3</div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-gray-400">Poster</h3>
            <p class="text-xs text-gray-400">Select artwork</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-lg shadow-lg">
      <div class="px-6 py-4 border-b">
        <h1 class="text-2xl font-bold text-gray-900">Viewing Details</h1>
        <p class="mt-1 text-sm text-gray-600">
          Where did you watch "<%= @movie.title %>"?
          <% if @viewing.viewed_on.present? %>
            <span class="text-gray-500">(on <%= @viewing.viewed_on.strftime('%B %d, %Y') %>)</span>
          <% end %>
        </p>
      </div>

      <div class="px-6 py-6">
        <%= form_with url: process_enrichment_admin_movie_path(@movie), 
            method: :patch,
            local: true,
            data: { turbo: false } do |f| %>
          
          <!-- Hidden field to indicate we want to continue to posters -->
          <%= f.hidden_field :continue_to_posters, value: true %>
          
          <%= f.fields_for :viewing, @viewing do |vf| %>
            <% if @viewing.persisted? %>
              <%= vf.hidden_field :id %>
            <% end %>
            
            <!-- Fix: Ensure viewed_on is properly set -->
            <%= vf.hidden_field :viewed_on, value: (@viewing.viewed_on || Date.current).to_s %>
            
            <div class="space-y-6">
              <!-- Location Selection -->
              <div>
                <%= vf.label :location, "Where did you watch?", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <div class="space-y-2">
                  <label class="flex items-center">
                    <%= vf.radio_button :location, 'home', 
                        checked: @viewing.location == 'home' || @viewing.location.blank?,
                        class: "mr-2 text-indigo-600 focus:ring-indigo-500",
                        'data-location-radio': 'home' %>
                    <span class="text-gray-700">Home</span>
                  </label>
                  
                  <label class="flex items-center">
                    <%= vf.radio_button :location, 'theater', 
                        checked: @viewing.location == 'theater',
                        class: "mr-2 text-indigo-600 focus:ring-indigo-500",
                        'data-location-radio': 'theater' %>
                    <span class="text-gray-700">Theater</span>
                  </label>
                </div>
              </div>
              
              <!-- Theater Details (shown when theater selected) -->
              <div data-theater-section style="<%= @viewing.location == 'theater' ? '' : 'display: none;' %>">
                <div class="p-4 bg-gray-50 rounded-lg space-y-4">
                  <h3 class="font-medium text-gray-900">Theater Details</h3>
                  
                  <!-- Theater Selection -->
                  <div>
                    <%= vf.label :theater_id, "Theater", class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <div class="flex items-center space-x-2">
                      <%= vf.select :theater_id, 
                          options_for_select(@theaters.map { |t| [t.name, t.id] }, @viewing.theater_id),
                          { include_blank: "Select a theater..." },
                          class: "flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
                      
                      <%= link_to "+", 
                          new_admin_theater_path(modal: true),
                          class: "px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700",
                          data: { turbo_frame: "modal" },
                          title: "Add new theater" %>
                    </div>
                  </div>
                  
                  <!-- Film Series (MOVED HERE - only for theater viewings) -->
                  <div>
                    <%= vf.label :film_series_event_id, "Part of a Film Series? (Optional)", 
                        class: "block text-sm font-medium text-gray-700 mb-1" %>
                    
                    <div class="space-y-2">
                      <!-- Series Selection (not part of form, just for UI) -->
                      <div class="flex items-center space-x-2">
                        <select id="film_series_selector"
                                data-film-series-select
                                class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                          <option value="">Select a series...</option>
                          <% @film_series.each do |series| %>
                            <% selected = @viewing.film_series_event&.film_series_id == series.id %>
                            <option value="<%= series.id %>" <%= 'selected' if selected %>>
                              <%= series.name %>
                            </option>
                          <% end %>
                        </select>
                        
                        <%= link_to "+", 
                            new_admin_film_series_path(modal: true),
                            class: "px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700",
                            data: { turbo_frame: "modal" },
                            title: "Add new series" %>
                      </div>
                      
                      <!-- Events Selection (the actual form field) -->
                      <div id="film_series_events_section"
                           data-film-series-events-section 
                           style="<%= @viewing.film_series_event_id.present? ? '' : 'display: none;' %>">
                        <%= vf.select :film_series_event_id,
                            options_for_select(@film_series_events.map { |e| 
                              ["#{e.name} (#{e.started_on.strftime('%b %d, %Y')})", e.id] 
                            }, @viewing.film_series_event_id),
                            { include_blank: "Select an event..." },
                            { 
                              id: "film_series_event_select",
                              class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                              'data-film-series-event-select': true
                            } %>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Optional Theater Fields -->
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <%= vf.label :price, "Ticket Price", class: "block text-sm font-medium text-gray-700 mb-1" %>
                      <%= vf.number_field :price, 
                          step: 0.01,
                          placeholder: "12.50",
                          class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
                    </div>
                    
                    <div>
                      <%= vf.label :format, "Format", class: "block text-sm font-medium text-gray-700 mb-1" %>
                      <%= vf.select :format,
                          options_for_select([
                            ['Standard', 'standard'],
                            ['IMAX', 'imax'],
                            ['Dolby', 'dolby'],
                            ['3D', '3d'],
                            ['70mm', '70mm'],
                            ['35mm', '35mm']
                          ], @viewing.format),
                          { include_blank: "Select format..." },
                          class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Additional Options (always shown) -->
              <div class="space-y-3">
                <label class="flex items-center">
                  <%= vf.check_box :rewatch, class: "mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" %>
                  <span class="text-sm text-gray-700">This was a rewatch</span>
                </label>
                
                <div>
                  <%= vf.label :notes, "Notes (Optional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= vf.text_area :notes, 
                      rows: 3,
                      class: "w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
                </div>
              </div>
            </div>
          <% end %>
          
          <!-- Navigation -->
          <div class="mt-8 pt-6 border-t flex justify-between">
            <%= link_to "← Back", 
                admin_movie_path(@movie),
                class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 font-medium" %>
            <div class="space-x-2">
              <%= f.submit "Save & Return", 
                  name: "save_and_return",
                  formaction: process_enrichment_admin_movie_path(@movie, continue_to_posters: false),
                  class: "px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 cursor-pointer font-medium" %>
              <%= f.submit "Continue to Posters →", 
                  class: "px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 cursor-pointer font-medium" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  // Turbo-compatible JavaScript for location toggle and film series
  
  function initializeEnrichStep2() {
    // Initialize location toggle
    initializeLocationToggle();
    // Initialize film series dropdown
    initializeFilmSeriesSelect();
  }
  
  function initializeLocationToggle() {
    const homeRadio = document.querySelector('[data-location-radio="home"]');
    const theaterRadio = document.querySelector('[data-location-radio="theater"]');
    const theaterSection = document.querySelector('[data-theater-section]');
    
    if (!homeRadio || !theaterRadio || !theaterSection) {
      console.warn('Location toggle elements not found');
      return;
    }
    
    function toggleTheaterSection() {
      if (theaterRadio.checked) {
        theaterSection.style.display = 'block';
      } else {
        theaterSection.style.display = 'none';
        // Clear theater-specific fields when hiding
        clearTheaterFields();
      }
    }
    
    function clearTheaterFields() {
      // Clear film series selection
      const seriesSelect = document.querySelector('[data-film-series-select]');
      if (seriesSelect) seriesSelect.value = '';
      
      // Hide and clear events section
      const eventsSection = document.querySelector('[data-film-series-events-section]');
      if (eventsSection) {
        eventsSection.style.display = 'none';
        const eventsSelect = eventsSection.querySelector('select');
        if (eventsSelect) eventsSelect.value = '';
      }
    }
    
    // Remove any existing listeners (to prevent duplicates)
    homeRadio.removeEventListener('change', toggleTheaterSection);
    theaterRadio.removeEventListener('change', toggleTheaterSection);
    
    // Add fresh listeners
    homeRadio.addEventListener('change', toggleTheaterSection);
    theaterRadio.addEventListener('change', toggleTheaterSection);
    
    // Set initial state
    toggleTheaterSection();
  }
  
  function initializeFilmSeriesSelect() {
    // Use IDs for more reliable selection
    const seriesSelect = document.getElementById('film_series_selector');
    const eventsSection = document.getElementById('film_series_events_section');
    const eventsSelect = document.getElementById('film_series_event_select');
    
    console.log('Film Series Debug:', {
      seriesSelect: !!seriesSelect,
      eventsSection: !!eventsSection,
      eventsSelect: !!eventsSelect
    });
    
    if (!seriesSelect) {
      console.error('Film series selector not found');
      return;
    }
    
    if (!eventsSection) {
      console.error('Film series events section not found');
      return;
    }
    
    // Events select might not exist initially, that's OK
    
    function handleSeriesChange() {
      const seriesId = seriesSelect.value;
      console.log('Film series changed to:', seriesId);
      
      if (!seriesId || seriesId === '') {
        // No series selected - hide events section
        eventsSection.style.display = 'none';
        
        // Clear the select if it exists
        const select = document.getElementById('film_series_event_select');
        if (select) {
          select.innerHTML = '<option value="">Select an event...</option>';
          select.value = '';
        }
        return;
      }
      
      // Show the section immediately
      eventsSection.style.display = 'block';
      
      // Get or create the select element
      let select = document.getElementById('film_series_event_select');
      if (!select) {
        console.error('Events select not found even after showing section');
        return;
      }
      
      // Show loading state
      select.innerHTML = '<option value="">Loading events...</option>';
      select.disabled = true;
      
      // Fetch events for this series
      fetch(`/admin/film_series_events/for_series?series_id=${seriesId}`)
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(events => {
          console.log('Received events:', events);
          
          let options = '<option value="">Select an event...</option>';
          
          if (events && events.length > 0) {
            events.forEach(event => {
              const date = new Date(event.started_on).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
              });
              options += `<option value="${event.id}">${event.name} (${date})</option>`;
            });
          } else {
            options = '<option value="">No events found for this series</option>';
          }
          
          select.innerHTML = options;
          select.disabled = false;
        })
        .catch(error => {
          console.error('Error loading film series events:', error);
          const select = document.getElementById('film_series_event_select');
          if (select) {
            select.innerHTML = '<option value="">Error loading events - check console</option>';
            select.disabled = false;
          }
        });
    }
    
    // Remove any existing listener
    seriesSelect.removeEventListener('change', handleSeriesChange);
    
    // Add fresh listener
    seriesSelect.addEventListener('change', handleSeriesChange);
    
    // If series is pre-selected, load events
    if (seriesSelect.value) {
      console.log('Series pre-selected:', seriesSelect.value);
      handleSeriesChange();
    }
  }
  
  // Initialize on different Turbo events to ensure it works with navigation

  // Initialize on page load and Turbo navigation
  document.addEventListener('DOMContentLoaded', initializeFilmSeriesSelect);
  document.addEventListener('turbo:load', initializeFilmSeriesSelect);
  document.addEventListener('turbo:frame-load', initializeFilmSeriesSelect);
  
  // Standard page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEnrichStep2);
  } else {
    // DOM already loaded
    initializeEnrichStep2();
  }
  
  // Turbo navigation
  document.addEventListener('turbo:load', initializeEnrichStep2);
  
  // Turbo frame updates
  document.addEventListener('turbo:frame-load', initializeEnrichStep2);
  
  // Turbo before cache (cleanup)
  document.addEventListener('turbo:before-cache', function() {
    // Clean up any state before caching
    const eventsSection = document.querySelector('[data-film-series-events-section]');
    if (eventsSection) {
      eventsSection.style.display = 'none';
    }
  });
</script>

<%= turbo_frame_tag "modal" %>
